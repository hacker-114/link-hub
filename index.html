<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hacker114</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    ul { list-style: none; padding-left: 1rem; }
    li.tree-item { margin: 2px 0; }
    a { text-decoration: none; color: #0cf; }
    .error { color: #e66; }
  </style>
</head>
<body>
  <header>
    <h1>Gaming Link Hub</h1>
    <h3>This collection was created by S-PScripts and Hacker114</h3>
    <h4>Some links may be blocked as the link hub was made for a separate school district!</h4>
  </header>

  <section id="search-section">
    <input type="text" id="search-input" placeholder="Search" />
  </section>

  <section id="file-tree-section">
    <div id="file-tree">Loading Resources...</div>
  </section>

  <script>
    const user = "S-PScripts";
    const repo = "chromebook-utilities";
    const branch = "main";
    const apiBase = `https://api.github.com/repos/${user}/${repo}/contents/`;

    const usePages = true;

    // âœ… Fixed makeURL: preserves repo subpath like /link-hub/
    function makeURL(path) {
      const origin = window.location.origin;
      let pathname = window.location.pathname.replace(/\/$/, ""); // strip trailing slash

      if (!usePages) {
        return `https://raw.githubusercontent.com/${user}/${repo}/${branch}/${path}`;
      }

      // Root domain case
      if (pathname === "" || pathname === "/") {
        return `${origin}/${path}`;
      }

      // Project repo case: keep subpath intact
      return `${origin}${pathname}/${path}`;
    }

    function makeErrorNode(message) {
      const li = document.createElement("li");
      li.className = "error";
      li.textContent = message;
      return li;
    }

    function buildFolderNode(name) {
      const li = document.createElement("li");
      li.classList.add("tree-item");
      li.setAttribute("data-name", name.toLowerCase());
      const label = document.createElement("strong");
      label.textContent = `[Category] ${name}`;
      li.appendChild(label);
      return li;
    }

    function buildFileNode(name, path) {
      const li = document.createElement("li");
      li.classList.add("tree-item");
      li.setAttribute("data-name", name.toLowerCase());
      const link = document.createElement("a");
      link.href = makeURL(path);
      link.target = "_blank";
      link.textContent = `[Link] ${name}`;
      li.appendChild(link);
      return li;
    }

    async function fetchTree(path = "") {
      const url = apiBase + path;
      try {
        const response = await fetch(url, {
          headers: { "Accept": "application/vnd.github.v3+json" }
        });
        if (!response.ok) {
          console.error("Fetch failed:", response.status, response.statusText, url);
          return makeErrorNode(`Error loading ${path || "root"}`);
        }

        const items = await response.json();
        if (!Array.isArray(items)) {
          return makeErrorNode("Unexpected response format");
        }

        const ul = document.createElement("ul");
        for (const item of items) {
          if (item.type === "dir") {
            const folderNode = buildFolderNode(item.name);
            const subTree = await fetchTree(item.path);
            folderNode.appendChild(subTree instanceof HTMLElement ? subTree : makeErrorNode("Error loading folder"));
            ul.appendChild(folderNode);
          } else if (item.type === "file") {
            ul.appendChild(buildFileNode(item.name, item.path));
          }
        }
        return ul;
      } catch (err) {
        console.error("Exception fetching:", err);
        return makeErrorNode(`Error loading ${path || "root"}`);
      }
    }

    (async function init() {
      const container = document.getElementById("file-tree");
      container.textContent = "Loading Resources...";
      const tree = await fetchTree();
      container.innerHTML = "";
      container.appendChild(tree);
    })();

    document.getElementById("search-input").addEventListener("input", function () {
      const query = this.value.toLowerCase();
      document.querySelectorAll(".tree-item").forEach(item => {
        const name = item.getAttribute("data-name") || "";
        item.style.display = name.includes(query) ? "" : "none";
      });
    });
  </script>
</body>
</html>
